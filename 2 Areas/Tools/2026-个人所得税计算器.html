<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2026 ä¸ªäººæ‰€å¾—ç¨è®¡ç®—å™¨</title>
    <style>
        /* === åŸºç¡€é‡ç½® === */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* === CSS å˜é‡ - ç°ä»£ç®€çº¦ä¸»é¢˜ === */
        :root {
            /* === èƒŒæ™¯è‰²ç³» === */
            --bg-primary: #FFFFFF;
            --bg-secondary: #F9FAFB;
            --bg-tertiary: #F3F4F6;

            /* === å¡ç‰‡å’Œå®¹å™¨ === */
            --card-bg: #FFFFFF;
            --card-hover: #F9FAFB;

            /* === è¾¹æ¡†ç³»ç»Ÿ === */
            --border-light: #E5E7EB;
            --border-medium: #D1D5DB;
            --border-focus: #3B82F6;

            /* === æ–‡å­—é¢œè‰² === */
            --text-primary: #111827;
            --text-secondary: #6B7280;
            --text-tertiary: #9CA3AF;
            --text-inverse: #FFFFFF;

            /* === ä¸»é¢˜è‰² - è“è‰²ç³» === */
            --primary-50: #EFF6FF;
            --primary-100: #DBEAFE;
            --primary-500: #3B82F6;
            --primary-600: #2563EB;
            --primary-700: #1D4ED8;

            /* === åŠŸèƒ½è‰² === */
            --success-50: #ECFDF5;
            --success-100: #D1FAE5;
            --success-500: #10B981;
            --success-600: #059669;

            --warning-50: #FFFBEB;
            --warning-100: #FEF3C7;
            --warning-500: #F59E0B;
            --warning-600: #D97706;

            --error-50: #FEF2F2;
            --error-100: #FEE2E2;
            --error-500: #EF4444;
            --error-600: #DC2626;

            --info-50: #ECFEFF;
            --info-100: #CFFAFE;
            --info-500: #06B6D4;
            --info-600: #0891B2;

            /* === é˜´å½±ç³»ç»Ÿ === */
            --shadow-xs: 0 1px 2px rgba(0, 0, 0, 0.05);
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1), 0 2px 4px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.1), 0 4px 6px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 20px 25px rgba(0, 0, 0, 0.1), 0 8px 10px rgba(0, 0, 0, 0.1);

            /* === åœ†è§’ç³»ç»Ÿ === */
            --radius-sm: 0.375rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;

            /* === é—´è· === */
            --spacing-xs: 0.75rem;
            --spacing-sm: 1rem;
            --spacing-md: 1.5rem;
            --spacing-lg: 2rem;
            --spacing-xl: 2.5rem;
            --spacing-2xl: 4rem;

            /* === è¿‡æ¸¡åŠ¨ç”» === */
            --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-base: 200ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: 300ms cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* === å…¨å±€æ ·å¼ === */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB',
                'Microsoft YaHei', sans-serif;
            background: var(--bg-secondary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* === å®¹å™¨ === */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: var(--spacing-lg);
        }

        /* === å¤´éƒ¨ === */
        .header {
            background: var(--card-bg);
            border-bottom: 1px solid var(--border-light);
            box-shadow: var(--shadow-xs);
            padding: var(--spacing-md) var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(8px);
            background: rgba(255, 255, 255, 0.9);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: var(--spacing-md);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .logo-icon {
            font-size: 2rem;
        }

        .logo-text h1 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .logo-text p {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        /* === æ¨¡å¼åˆ‡æ¢ === */
        .mode-switch {
            display: flex;
            gap: var(--spacing-xs);
            background: var(--bg-tertiary);
            padding: 0.25rem;
            border-radius: var(--radius-lg);
        }

        .mode-btn {
            padding: 0.5rem 1.5rem;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            font-weight: 600;
            transition: all var(--transition-base);
        }

        .mode-btn.active {
            background: var(--card-bg);
            color: var(--primary-600);
            box-shadow: var(--shadow-sm);
        }

        .mode-btn:hover:not(.active) {
            color: var(--text-primary);
            background: rgba(0, 0, 0, 0.05);
        }

        /* === å·¥å…·æ æŒ‰é’® === */
        .toolbar {
            display: flex;
            gap: var(--spacing-sm);
        }

        .toolbar-btn {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border-light);
            background: var(--card-bg);
            color: var(--text-primary);
            cursor: pointer;
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            font-weight: 600;
            transition: all var(--transition-base);
        }

        .toolbar-btn:hover {
            border-color: var(--border-medium);
            box-shadow: var(--shadow-sm);
            transform: translateY(-1px);
        }

        .toolbar-btn.danger:hover {
            border-color: var(--error-500);
            color: var(--error-600);
        }

        /* === ä¸»ä½“å¸ƒå±€ === */
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-xl);
        }

        /* === å·¦å³åˆ—å®¹å™¨ === */
        .left-column,
        .right-column {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-xl);
        }

        /* === å¡ç‰‡ === */
        .card {
            background: var(--card-bg);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-xl);
            padding: var(--spacing-lg);
            box-shadow: var(--shadow-sm);
            transition: all var(--transition-base);
            animation: fadeInUp 0.4s ease forwards;
            opacity: 0;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .card:nth-child(1) {
            animation-delay: 0.1s;
        }

        .card:nth-child(2) {
            animation-delay: 0.2s;
        }

        .card:nth-child(3) {
            animation-delay: 0.3s;
        }

        .card:nth-child(4) {
            animation-delay: 0.4s;
        }

        .card:hover {
            box-shadow: var(--shadow-md);
            border-color: var(--border-medium);
        }

        .card-title {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: var(--spacing-md);
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            color: var(--text-primary);
        }

        .card-title::before {
            content: '';
            width: 4px;
            height: 1.125rem;
            background: var(--primary-500);
            border-radius: 2px;
            margin-right: var(--spacing-xs);
        }

        /* === è¡¨å•å…ƒç´  === */
        .form-group {
            margin-bottom: var(--spacing-md);
        }

        .form-label {
            display: block;
            margin-bottom: var(--spacing-xs);
            font-size: 0.875rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .form-input {
            width: 100%;
            padding: 0.75rem 1rem;
            background: var(--card-bg);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-lg);
            color: var(--text-primary);
            font-size: 0.875rem;
            transition: all var(--transition-base);
            font-family: 'SF Mono', 'Consolas', monospace;
        }

        .form-input:hover {
            border-color: var(--border-medium);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--border-focus);
            box-shadow: 0 0 0 3px var(--primary-100);
        }

        .form-input::placeholder {
            color: var(--text-tertiary);
        }

        /* === æŒ‰é’®ç»„ === */
        .button-group {
            display: flex;
            gap: var(--spacing-xs);
            flex-wrap: wrap;
        }

        .btn-option {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border-light);
            background: var(--card-bg);
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: var(--radius-lg);
            font-size: 0.875rem;
            font-weight: 600;
            transition: all var(--transition-fast);
        }

        .btn-option:hover {
            background: var(--bg-secondary);
            border-color: var(--border-medium);
            color: var(--text-primary);
        }

        .btn-option.active {
            background: var(--primary-50);
            border-color: var(--primary-500);
            color: var(--primary-600);
        }

        /* === å•é€‰æŒ‰é’® === */
        .radio-group {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-xs);
        }

        .radio-option {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            background: var(--card-bg);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .radio-option:hover {
            background: var(--bg-secondary);
            border-color: var(--border-medium);
        }

        .radio-option.active {
            background: var(--primary-50);
            border-color: var(--primary-500);
        }

        .radio-circle {
            width: 1.25rem;
            height: 1.25rem;
            border: 2px solid var(--border-medium);
            border-radius: 50%;
            margin-right: var(--spacing-sm);
            position: relative;
            transition: all var(--transition-base);
        }

        .radio-option.active .radio-circle {
            border-color: var(--primary-500);
            background: var(--primary-500);
        }

        .radio-option.active .radio-circle::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 0.375rem;
            height: 0.375rem;
            background: white;
            border-radius: 50%;
        }

        .radio-label {
            flex: 1;
            font-size: 0.875rem;
            color: var(--text-primary);
        }

        .radio-value {
            font-size: 0.875rem;
            color: var(--text-secondary);
            font-weight: 600;
        }

        .radio-option.active .radio-value {
            color: var(--primary-600);
        }

        /* === åˆ†éš”çº¿ === */
        .divider {
            height: 1px;
            background: var(--border-light);
            margin: var(--spacing-md) 0;
        }

        /* === åˆè®¡æ˜¾ç¤º === */
        .total-display {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-md);
            background: var(--bg-secondary);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-lg);
            margin-top: var(--spacing-sm);
        }

        .total-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .total-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary-600);
            font-family: 'SF Mono', 'Consolas', monospace;
        }

        /* === ç»“æœæ˜¾ç¤ºåŒº === */
        .result-main {
            text-align: center;
            padding: var(--spacing-xl) 0;
            background: var(--bg-secondary);
            border-radius: var(--radius-xl);
            margin-bottom: var(--spacing-lg);
        }

        .result-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: var(--spacing-sm);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .result-amount {
            font-size: 3rem;
            font-weight: 700;
            color: var(--primary-600);
            font-family: 'SF Mono', 'Consolas', monospace;
            margin-bottom: var(--spacing-lg);
        }

        .result-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-md);
        }

        .result-item {
            padding: var(--spacing-md);
            background: var(--bg-tertiary);
            border-radius: var(--radius-lg);
        }

        .result-item-label {
            font-size: 0.75rem;
            color: var(--text-tertiary);
            margin-bottom: 0.25rem;
        }

        .result-item-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--success-600);
            font-family: 'SF Mono', 'Consolas', monospace;
        }

        .result-item-value.rate {
            color: var(--warning-600);
        }

        /* === è­¦å‘Šæç¤º === */
        .alert {
            padding: var(--spacing-sm);
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            margin-top: var(--spacing-sm);
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
        }

        .alert-warning {
            background: var(--warning-50);
            border: 1px solid var(--warning-100);
            color: var(--warning-600);
        }

        .alert-error {
            background: var(--error-50);
            border: 1px solid var(--error-100);
            color: var(--error-600);
            animation: shake 0.5s ease;
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-5px);
            }

            75% {
                transform: translateX(5px);
            }
        }

        /* === æç¤ºå›¾æ ‡ === */
        .info-icon {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 1px solid var(--text-tertiary);
            border-radius: 50%;
            text-align: center;
            line-height: 14px;
            font-size: 12px;
            cursor: help;
            margin-left: 0.25rem;
            color: var(--text-tertiary);
            transition: all var(--transition-fast);
        }

        .info-icon:hover {
            border-color: var(--border-focus);
            color: var(--border-focus);
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.2);
        }

        /* === æŠ˜å é¢æ¿ === */
        .collapse-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding: var(--spacing-sm);
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            margin-bottom: var(--spacing-sm);
            transition: all var(--transition-base);
        }

        .collapse-header:hover {
            background: var(--border-light);
        }

        .collapse-icon {
            transition: transform var(--transition-normal);
        }

        .collapse-icon.expanded {
            transform: rotate(180deg);
        }

        .collapse-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height var(--transition-normal);
        }

        .collapse-content.expanded {
            max-height: 2000px;
        }

        /* === å“åº”å¼ === */
        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: var(--spacing-md);
            }

            .header {
                padding: var(--spacing-sm) var(--spacing-md);
            }

            .header-content {
                flex-direction: column;
                align-items: stretch;
                gap: var(--spacing-sm);
            }

            .logo-text h1 {
                font-size: 1.25rem;
            }

            .toolbar {
                width: 100%;
                justify-content: space-between;
            }

            .mode-switch {
                width: 100%;
            }

            .mode-btn {
                flex: 1;
                text-align: center;
            }

            .result-amount {
                font-size: 2rem;
            }

            .result-grid {
                grid-template-columns: 1fr;
            }
        }

        /* === éšè—ç±» === */
        .hidden {
            display: none !important;
        }

        /* === åŠ è½½åŠ¨ç”» === */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-light);
            border-top-color: var(--primary-500);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* === æ•°å­—è¾“å…¥æ¡†å¢å¼º === */
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            opacity: 0.5;
        }

        input[type="number"]:hover::-webkit-inner-spin-button,
        input[type="number"]:hover::-webkit-outer-spin-button {
            opacity: 1;
        }

        /* === é€‰æ‹©æ¡†æ ·å¼ === */
        select.form-input {
            cursor: pointer;
            background-image: url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1L6 6L11 1' stroke='%236B7280' stroke-width='2' stroke-linecap='round'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            padding-right: 2.5rem;
        }

        /* === æ¯”ä¾‹é€‰æ‹©æŒ‰é’®å¢å¼º === */
        .button-group [data-ratio] {
            position: relative;
            overflow: hidden;
        }

        .button-group [data-ratio]::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 0;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.1), transparent);
            transition: width 0.3s ease;
        }

        .button-group [data-ratio]:hover::before {
            width: 100%;
        }

        /* === æ•°å€¼é«˜äº®åŠ¨ç”» === */
        @keyframes valueChange {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }
        }

        .value-changed {
            animation: valueChange 0.3s ease;
        }

        /* === è¿›åº¦æ¡å®¹å™¨ === */
        .progress-bar-container {
            width: 100%;
            height: 8px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-full);
            overflow: hidden;
            position: relative;
        }

        .progress-bar {
            height: 100%;
            border-radius: var(--radius-full);
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% {
                transform: translateX(-100%);
            }

            100% {
                transform: translateX(100%);
            }
        }

        /* === å·¥å…·æç¤º === */
        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            min-width: 200px;
            background: rgba(17, 24, 39, 0.95);
            color: var(--text-primary);
            text-align: left;
            border-radius: var(--radius-md);
            padding: var(--spacing-sm);
            position: absolute;
            z-index: 1000;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity var(--transition-base);
            font-size: 0.75rem;
            line-height: 1.4;
            border: 1px solid var(--border-medium);
            box-shadow: var(--shadow-md);
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        /* === æ»šåŠ¨æ¡æ ·å¼ === */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-tertiary);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-medium);
            border-radius: 4px;
            transition: background var(--transition-fast);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--border-focus);
        }

        /* === æ‰“å°æ ·å¼ === */
        @media print {
            body {
                background: white;
                color: black;
            }

            .header,
            .toolbar,
            .mode-switch,
            .toolbar-btn {
                display: none;
            }

            .card {
                break-inside: avoid;
                border: 1px solid #ddd;
                background: white;
            }

            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        /* === ç„¦ç‚¹å¯è§æ€§ === */
        *:focus-visible {
            outline: 2px solid var(--border-focus);
            outline-offset: 2px;
        }

        button:focus-visible,
        input:focus-visible,
        select:focus-visible {
            outline: 2px solid var(--border-focus);
            outline-offset: 2px;
        }
    </style>
</head>

<body>
    <!-- å¤´éƒ¨ -->
    <div class="container">
        <div class="header">
            <div class="header-content">
                <div class="logo">
                    <div class="logo-icon">ğŸ’°</div>
                    <div class="logo-text">
                        <h1>2026 ä¸ªäººæ‰€å¾—ç¨è®¡ç®—å™¨</h1>
                        <p>ç²¾å‡†è®¡ç®— Â· æ™ºèƒ½åˆ†æ Â· å®æ—¶æ›´æ–°</p>
                    </div>
                </div>

                <div class="mode-switch">
                    <button class="mode-btn active" data-mode="monthly">æœˆåº¦è®¡ç¨</button>
                    <button class="mode-btn" data-mode="yearly">å¹´åº¦æ±‡ç®—</button>
                </div>

                <div class="toolbar">
                    <button class="toolbar-btn" id="importBtn">å¯¼å…¥</button>
                    <button class="toolbar-btn" id="exportBtn">å¯¼å‡º</button>
                    <button class="toolbar-btn danger" id="clearBtn">æ¸…ç©º</button>
                </div>
            </div>
        </div>

        <!-- ä¸»ä½“å†…å®¹ -->
        <div class="main-grid">
            <!-- å·¦ä¾§ï¼šè¾“å…¥åŒº -->
            <div class="left-column">
                <!-- æ”¶å…¥ä¿¡æ¯ -->
                <div class="card">
                    <h3 class="card-title">æ”¶å…¥ä¿¡æ¯</h3>

                    <!-- å¹´åº¦æ±‡ç®—æ¨¡å¼ï¼šæ˜¾ç¤ºå¹´åº¦æ€»æ”¶å…¥ -->
                    <div class="form-group yearly-only hidden">
                        <label class="form-label">å¹´åº¦æ€»æ”¶å…¥</label>
                        <input type="number" class="form-input" id="yearlyIncomeInput" placeholder="è¯·è¾“å…¥å¹´åº¦æ€»æ”¶å…¥" min="0"
                            step="100">
                    </div>

                    <!-- æœˆåº¦è®¡ç¨æ¨¡å¼ -->
                    <div class="monthly-only">
                        <!-- å¿«æ·è¾“å…¥ï¼šé€‚åˆå·¥èµ„å›ºå®šçš„æƒ…å†µ -->
                        <div class="form-group">
                            <label class="form-label">æœˆå·¥èµ„æ”¶å…¥ï¼ˆè‡ªåŠ¨åº”ç”¨åˆ°å…¨å¹´ï¼‰</label>
                            <input type="number" class="form-input" id="monthlyIncomeInput" placeholder="è¯·è¾“å…¥æœˆå·¥èµ„" min="0"
                                step="100">
                        </div>

                        <!-- å¯å±•å¼€çš„æœˆåº¦æ˜ç»†ï¼šç”¨äºç‰¹æ®Šæƒ…å†µè°ƒæ•´ -->
                        <div class="collapse-section">
                            <div class="collapse-header" data-target="monthlyIncomeDetails">
                                <span>æœˆåº¦å·¥èµ„æ˜ç»†ï¼ˆç‚¹å‡»å±•å¼€å•ç‹¬è°ƒæ•´ï¼‰</span>
                                <span class="collapse-icon">â–¼</span>
                            </div>
                            <div class="collapse-content" id="monthlyIncomeDetails">
                                <div
                                    style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-sm); margin-top: var(--spacing-sm);">
                                    <div class="form-group" style="margin-bottom: var(--spacing-sm);">
                                        <label class="form-label" style="font-size: 0.75rem;">1æœˆå·¥èµ„</label>
                                        <input type="number" class="form-input monthly-income-input" data-month="1"
                                            placeholder="0" min="0" step="100">
                                    </div>
                                    <div class="form-group" style="margin-bottom: var(--spacing-sm);">
                                        <label class="form-label" style="font-size: 0.75rem;">2æœˆå·¥èµ„</label>
                                        <input type="number" class="form-input monthly-income-input" data-month="2"
                                            placeholder="0" min="0" step="100">
                                    </div>
                                    <div class="form-group" style="margin-bottom: var(--spacing-sm);">
                                        <label class="form-label" style="font-size: 0.75rem;">3æœˆå·¥èµ„</label>
                                        <input type="number" class="form-input monthly-income-input" data-month="3"
                                            placeholder="0" min="0" step="100">
                                    </div>
                                    <div class="form-group" style="margin-bottom: var(--spacing-sm);">
                                        <label class="form-label" style="font-size: 0.75rem;">4æœˆå·¥èµ„</label>
                                        <input type="number" class="form-input monthly-income-input" data-month="4"
                                            placeholder="0" min="0" step="100">
                                    </div>
                                    <div class="form-group" style="margin-bottom: var(--spacing-sm);">
                                        <label class="form-label" style="font-size: 0.75rem;">5æœˆå·¥èµ„</label>
                                        <input type="number" class="form-input monthly-income-input" data-month="5"
                                            placeholder="0" min="0" step="100">
                                    </div>
                                    <div class="form-group" style="margin-bottom: var(--spacing-sm);">
                                        <label class="form-label" style="font-size: 0.75rem;">6æœˆå·¥èµ„</label>
                                        <input type="number" class="form-input monthly-income-input" data-month="6"
                                            placeholder="0" min="0" step="100">
                                    </div>
                                    <div class="form-group" style="margin-bottom: var(--spacing-sm);">
                                        <label class="form-label" style="font-size: 0.75rem;">7æœˆå·¥èµ„</label>
                                        <input type="number" class="form-input monthly-income-input" data-month="7"
                                            placeholder="0" min="0" step="100">
                                    </div>
                                    <div class="form-group" style="margin-bottom: var(--spacing-sm);">
                                        <label class="form-label" style="font-size: 0.75rem;">8æœˆå·¥èµ„</label>
                                        <input type="number" class="form-input monthly-income-input" data-month="8"
                                            placeholder="0" min="0" step="100">
                                    </div>
                                    <div class="form-group" style="margin-bottom: var(--spacing-sm);">
                                        <label class="form-label" style="font-size: 0.75rem;">9æœˆå·¥èµ„</label>
                                        <input type="number" class="form-input monthly-income-input" data-month="9"
                                            placeholder="0" min="0" step="100">
                                    </div>
                                    <div class="form-group" style="margin-bottom: var(--spacing-sm);">
                                        <label class="form-label" style="font-size: 0.75rem;">10æœˆå·¥èµ„</label>
                                        <input type="number" class="form-input monthly-income-input" data-month="10"
                                            placeholder="0" min="0" step="100">
                                    </div>
                                    <div class="form-group" style="margin-bottom: var(--spacing-sm);">
                                        <label class="form-label" style="font-size: 0.75rem;">11æœˆå·¥èµ„</label>
                                        <input type="number" class="form-input monthly-income-input" data-month="11"
                                            placeholder="0" min="0" step="100">
                                    </div>
                                    <div class="form-group" style="margin-bottom: var(--spacing-sm);">
                                        <label class="form-label" style="font-size: 0.75rem;">12æœˆå·¥èµ„</label>
                                        <input type="number" class="form-input monthly-income-input" data-month="12"
                                            placeholder="0" min="0" step="100">
                                    </div>
                                </div>
                                <div class="alert alert-warning" style="margin-top: var(--spacing-sm);">
                                    ğŸ’¡ æç¤ºï¼šå¦‚æœå·¥èµ„æœ‰å˜åŠ¨ï¼ˆå¦‚åŠ è–ªã€è¡¥äº¤ç¤¾ä¿ç­‰ï¼‰ï¼Œå¯å•ç‹¬è°ƒæ•´å¯¹åº”æœˆä»½çš„å·¥èµ„
                                </div>
                            </div>
                        </div>

                        <div class="total-display" style="margin-top: var(--spacing-md);">
                            <span class="total-label">å¹´åº¦å·¥èµ„æ€»è®¡</span>
                            <span class="total-value" id="totalYearlyIncome">Â¥ 0</span>
                        </div>
                    </div>
                </div>

                <!-- ä¸“é¡¹æ‰£é™¤ï¼ˆç¤¾ä¿å…¬ç§¯é‡‘ï¼‰ -->
                <div class="card">
                    <h3 class="card-title">ä¸“é¡¹æ‰£é™¤ï¼ˆç¤¾ä¿å…¬ç§¯é‡‘ï¼‰</h3>

                    <div class="button-group" style="margin-bottom: var(--spacing-md);">
                        <button class="btn-option active" data-preset="22.5">ä¼ä¸šæ ‡å‡† 22.5%</button>
                        <button class="btn-option" data-preset="custom">è‡ªå®šä¹‰</button>
                    </div>

                    <div class="form-group">
                        <label class="form-label">å…»è€ä¿é™© (8%)</label>
                        <input type="number" class="form-input social-input" id="pensionInput" placeholder="0" min="0"
                            step="10">
                    </div>

                    <div class="form-group">
                        <label class="form-label">åŒ»ç–—ä¿é™© (2%)</label>
                        <input type="number" class="form-input social-input" id="medicalInput" placeholder="0" min="0"
                            step="10">
                    </div>

                    <div class="form-group">
                        <label class="form-label">å¤±ä¸šä¿é™© (0.5%)</label>
                        <input type="number" class="form-input social-input" id="unemploymentInput" placeholder="0"
                            min="0" step="10">
                    </div>

                    <div class="form-group">
                        <label class="form-label">ä½æˆ¿å…¬ç§¯é‡‘ (12%)</label>
                        <input type="number" class="form-input social-input" id="housingFundInput" placeholder="0"
                            min="0" step="10">
                    </div>

                    <div class="total-display">
                        <span class="total-label">ä¸“é¡¹æ‰£é™¤åˆè®¡</span>
                        <span class="total-value" id="socialTotal">Â¥ 0</span>
                    </div>
                </div>

                <!-- ä¸“é¡¹é™„åŠ æ‰£é™¤ -->
                <div class="card">
                    <h3 class="card-title">ä¸“é¡¹é™„åŠ æ‰£é™¤</h3>

                    <!-- å­å¥³æ•™è‚² -->
                    <div class="collapse-section">
                        <div class="collapse-header" data-target="childEducation">
                            <span>å­å¥³æ•™è‚²</span>
                            <span class="collapse-icon">â–¼</span>
                        </div>
                        <div class="collapse-content" id="childEducation">
                            <div class="form-group">
                                <label class="form-label">å­©å­æ•°é‡</label>
                                <div class="button-group">
                                    <button class="btn-option active" data-children="0">0</button>
                                    <button class="btn-option" data-children="1">1</button>
                                    <button class="btn-option" data-children="2">2</button>
                                    <button class="btn-option" data-children="3">3+</button>
                                </div>
                            </div>
                            <div class="form-group child-options hidden">
                                <label class="form-label">æ‰£é™¤æ¯”ä¾‹</label>
                                <div class="button-group">
                                    <button class="btn-option active" data-ratio="100">100%</button>
                                    <button class="btn-option" data-ratio="50">50%</button>
                                </div>
                            </div>
                            <div class="total-display child-options hidden">
                                <span class="total-label">æ‰£é™¤é‡‘é¢</span>
                                <span class="total-value" id="childEduAmount">Â¥ 0</span>
                            </div>
                        </div>
                    </div>

                    <div class="divider"></div>

                    <!-- 3å²ä»¥ä¸‹å©´å¹¼å„¿ç…§æŠ¤ -->
                    <div class="collapse-section">
                        <div class="collapse-header" data-target="infantCare">
                            <span>3å²ä»¥ä¸‹å©´å¹¼å„¿ç…§æŠ¤</span>
                            <span class="collapse-icon">â–¼</span>
                        </div>
                        <div class="collapse-content" id="infantCare">
                            <div class="form-group">
                                <label class="form-label">å©´å„¿æ•°é‡</label>
                                <div class="button-group">
                                    <button class="btn-option active" data-infants="0">0</button>
                                    <button class="btn-option" data-infants="1">1</button>
                                    <button class="btn-option" data-infants="2">2</button>
                                    <button class="btn-option" data-infants="3">3+</button>
                                </div>
                            </div>
                            <div class="form-group infant-options hidden">
                                <label class="form-label">æ‰£é™¤æ¯”ä¾‹</label>
                                <div class="button-group">
                                    <button class="btn-option active" data-ratio="100">100%</button>
                                    <button class="btn-option" data-ratio="50">50%</button>
                                </div>
                            </div>
                            <div class="total-display infant-options hidden">
                                <span class="total-label">æ‰£é™¤é‡‘é¢</span>
                                <span class="total-value" id="infantAmount">Â¥ 0</span>
                            </div>
                        </div>
                    </div>

                    <div class="divider"></div>

                    <!-- ç»§ç»­æ•™è‚² -->
                    <div class="collapse-section">
                        <div class="collapse-header" data-target="education">
                            <span>ç»§ç»­æ•™è‚²</span>
                            <span class="collapse-icon">â–¼</span>
                        </div>
                        <div class="collapse-content" id="education">
                            <div class="radio-group">
                                <div class="radio-option active" data-edu-type="none">
                                    <div class="radio-circle"></div>
                                    <span class="radio-label">æ— </span>
                                    <span class="radio-value">Â¥ 0</span>
                                </div>
                                <div class="radio-option" data-edu-type="academic">
                                    <div class="radio-circle"></div>
                                    <span class="radio-label">å­¦å†(å­¦ä½)æ•™è‚²</span>
                                    <span class="radio-value">Â¥ 400/æœˆ</span>
                                </div>
                                <div class="radio-option" data-edu-type="vocational">
                                    <div class="radio-circle"></div>
                                    <span class="radio-label">èŒä¸šèµ„æ ¼è¯ä¹¦</span>
                                    <span class="radio-value yearly-only hidden">Â¥ 3,600/å¹´</span>
                                    <span class="radio-value monthly-only">Â¥ 300/æœˆ</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="divider"></div>

                    <!-- ä½æˆ¿æ”¯å‡º -->
                    <div class="collapse-section">
                        <div class="collapse-header" data-target="housing">
                            <span>ä½æˆ¿æ”¯å‡º</span>
                            <span class="collapse-icon">â–¼</span>
                        </div>
                        <div class="collapse-content" id="housing">
                            <div class="radio-group">
                                <div class="radio-option active" data-housing-type="none">
                                    <div class="radio-circle"></div>
                                    <span class="radio-label">æ— </span>
                                    <span class="radio-value">Â¥ 0</span>
                                </div>
                                <div class="radio-option" data-housing-type="loan">
                                    <div class="radio-circle"></div>
                                    <span class="radio-label">é¦–å¥—æˆ¿è´·åˆ©æ¯</span>
                                    <span class="radio-value">Â¥ 1,000/æœˆ</span>
                                </div>
                                <div class="radio-option" data-housing-type="rent">
                                    <div class="radio-circle"></div>
                                    <span class="radio-label">ä½æˆ¿ç§Ÿé‡‘</span>
                                    <span class="radio-value">æ ¹æ®åŸå¸‚</span>
                                </div>
                            </div>

                            <div class="form-group rent-options hidden" style="margin-top: var(--spacing-sm);">
                                <label class="form-label">åŸå¸‚æ¡£æ¬¡</label>
                                <div class="radio-group">
                                    <div class="radio-option active" data-city-tier="tier1">
                                        <div class="radio-circle"></div>
                                        <span class="radio-label">ç›´è¾–å¸‚/çœä¼š/è®¡åˆ’å•åˆ—å¸‚</span>
                                        <span class="radio-value">Â¥ 1,500/æœˆ</span>
                                    </div>
                                    <div class="radio-option" data-city-tier="tier2">
                                        <div class="radio-circle"></div>
                                        <span class="radio-label">ç™¾ä¸‡äººå£ä»¥ä¸ŠåŸå¸‚</span>
                                        <span class="radio-value">Â¥ 1,100/æœˆ</span>
                                    </div>
                                    <div class="radio-option" data-city-tier="tier3">
                                        <div class="radio-circle"></div>
                                        <span class="radio-label">å…¶ä»–åŸå¸‚</span>
                                        <span class="radio-value">Â¥ 800/æœˆ</span>
                                    </div>
                                </div>
                            </div>

                            <div class="alert alert-warning housing-warning hidden">
                                âš ï¸ æˆ¿è´·åˆ©æ¯å’Œä½æˆ¿ç§Ÿé‡‘ä¸èƒ½åŒæ—¶æ‰£é™¤
                            </div>
                        </div>
                    </div>

                    <div class="divider"></div>

                    <!-- èµ¡å…»è€äºº -->
                    <div class="collapse-section">
                        <div class="collapse-header" data-target="elderCare">
                            <span>èµ¡å…»è€äºº</span>
                            <span class="collapse-icon">â–¼</span>
                        </div>
                        <div class="collapse-content" id="elderCare">
                            <div class="form-group">
                                <label class="form-label">çˆ¶æ¯å¹´é¾„</label>
                                <div class="radio-group">
                                    <div class="radio-option active" data-elder-age="none">
                                        <div class="radio-circle"></div>
                                        <span class="radio-label">å‡æœªæ»¡60å²</span>
                                    </div>
                                    <div class="radio-option" data-elder-age="qualified">
                                        <div class="radio-circle"></div>
                                        <span class="radio-label">è‡³å°‘ä¸€æ–¹å¹´æ»¡60å²</span>
                                    </div>
                                </div>
                            </div>

                            <div class="form-group elder-options hidden">
                                <label class="form-label">èµ¡å…»äººæ•°ï¼ˆå…„å¼Ÿå§å¦¹ï¼‰</label>
                                <div class="button-group">
                                    <button class="btn-option active" data-siblings="1">1äººï¼ˆç‹¬ç”Ÿï¼‰</button>
                                    <button class="btn-option" data-siblings="2">2äºº</button>
                                    <button class="btn-option" data-siblings="3">3äºº</button>
                                    <button class="btn-option" data-siblings="4">4äºº+</button>
                                </div>
                            </div>

                            <div class="form-group elder-share hidden">
                                <label class="form-label">åˆ†æ‘Šé‡‘é¢ (æœ€é«˜ Â¥1,500/æœˆ)</label>
                                <input type="number" class="form-input" id="elderShareInput" placeholder="0" min="0"
                                    max="1500" step="100">
                            </div>

                            <div class="total-display elder-options hidden">
                                <span class="total-label">æ‰£é™¤é‡‘é¢</span>
                                <span class="total-value" id="elderAmount">Â¥ 0</span>
                            </div>
                        </div>
                    </div>

                    <div class="divider"></div>

                    <!-- å¤§ç—…åŒ»ç–—ï¼ˆä»…å¹´åº¦ï¼‰ -->
                    <div class="collapse-section yearly-only hidden">
                        <div class="collapse-header" data-target="medical">
                            <span>å¤§ç—…åŒ»ç–—</span>
                            <span class="collapse-icon">â–¼</span>
                        </div>
                        <div class="collapse-content" id="medical">
                            <div class="form-group">
                                <label class="form-label">ä¸ªäººè‡ªä»˜é‡‘é¢ï¼ˆè¶…è¿‡1.5ä¸‡å…ƒçš„éƒ¨åˆ†ï¼‰</label>
                                <input type="number" class="form-input" id="medicalExpenseInput" placeholder="0" min="0"
                                    step="1000">
                            </div>
                            <div class="alert alert-warning">
                                â“˜ æ‰£é™¤èŒƒå›´ï¼šè¶…è¿‡15,000å…ƒçš„éƒ¨åˆ†ï¼Œæœ€é«˜80,000å…ƒ
                            </div>
                            <div class="total-display">
                                <span class="total-label">æ‰£é™¤é‡‘é¢</span>
                                <span class="total-value" id="medicalAmount">Â¥ 0</span>
                            </div>
                        </div>
                    </div>

                    <div class="divider"></div>

                    <div class="total-display">
                        <span class="total-label">é™„åŠ æ‰£é™¤åˆè®¡</span>
                        <span class="total-value" id="additionalTotal">Â¥ 0</span>
                    </div>
                </div>

                <!-- å¹´ç»ˆå¥– -->
                <div class="card">
                    <h3 class="card-title">å¹´ç»ˆå¥–</h3>

                    <div class="form-group">
                        <label class="form-label">å¹´ç»ˆå¥–é‡‘é¢</label>
                        <input type="number" class="form-input" id="bonusInput" placeholder="0" min="0" step="1000">
                    </div>

                    <div id="bonusComparison" class="hidden">
                        <div class="divider"></div>
                        <div
                            style="margin-bottom: var(--spacing-sm); color: var(--text-secondary); font-size: 0.875rem;">
                            ğŸ’¡ è®¡ç¨æ–¹å¼å¯¹æ¯”
                        </div>

                        <div class="result-grid" style="margin-bottom: var(--spacing-sm);">
                            <div class="result-item">
                                <div class="result-item-label">å•ç‹¬è®¡ç¨</div>
                                <div class="result-item-value" id="bonusSeparateTax">Â¥ 0</div>
                            </div>
                            <div class="result-item">
                                <div class="result-item-label">åˆå¹¶è®¡ç¨</div>
                                <div class="result-item-value" id="bonusCombinedTax">Â¥ 0</div>
                            </div>
                        </div>

                        <div class="alert alert-warning" id="bonusRecommendation">
                            âœ“ æ¨èä½¿ç”¨å•ç‹¬è®¡ç¨ï¼Œå¯èŠ‚çœ Â¥0
                        </div>
                    </div>
                </div>
            </div>

            <!-- å³ä¾§ï¼šç»“æœåŒº -->
            <div class="right-column">
                <!-- è®¡ç®—ç»“æœ -->
                <div class="card">
                    <div class="result-main">
                        <div class="result-label">åº”çº³ç¨é¢</div>
                        <div class="result-amount" id="totalTaxAmount">Â¥ 0</div>

                        <div class="result-grid">
                            <div class="result-item">
                                <div class="result-item-label">å®é™…åˆ°æ‰‹</div>
                                <div class="result-item-value" id="netIncome">Â¥ 0</div>
                            </div>
                            <div class="result-item">
                                <div class="result-item-label">æœ‰æ•ˆç¨ç‡</div>
                                <div class="result-item-value rate" id="effectiveRate">0%</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æœˆåº¦æ˜ç»† -->
                <div class="card monthly-only">
                    <h3 class="card-title">æœˆåº¦æ˜ç»†</h3>
                    <div id="monthlyDetails">
                        <div class="monthly-table-wrapper">
                            <table class="monthly-table" style="width: 100%; border-collapse: collapse; font-size: 0.875rem;">
                                <thead>
                                    <tr style="border-bottom: 2px solid var(--border-light);">
                                        <th style="padding: 0.75rem 0.5rem; text-align: left; color: var(--text-secondary); font-weight: 600;">æœˆä»½</th>
                                        <th style="padding: 0.75rem 0.5rem; text-align: right; color: var(--text-secondary); font-weight: 600;">ç¨å‰å·¥èµ„</th>
                                        <th style="padding: 0.75rem 0.5rem; text-align: right; color: var(--text-secondary); font-weight: 600;">å½“æœˆä¸ªç¨</th>
                                        <th style="padding: 0.75rem 0.5rem; text-align: right; color: var(--text-secondary); font-weight: 600;">åˆ°æ‰‹å·¥èµ„</th>
                                    </tr>
                                </thead>
                                <tbody id="monthlyTableBody">
                                    <!-- ç”± JavaScript åŠ¨æ€ç”Ÿæˆ -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- æ”¶å…¥åˆ†è§£ -->
                <div class="card">
                    <h3 class="card-title">æ”¶å…¥åˆ†è§£</h3>
                    <div id="incomeBreakdown">
                        <!-- è¿™é‡Œå°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆå¯è§†åŒ–å†…å®¹ -->
                    </div>
                </div>

                <!-- ç¨é¢æ˜ç»† -->
                <div class="card">
                    <h3 class="card-title">ç¨é¢æ˜ç»†</h3>
                    <div id="taxDetails">
                        <!-- è¿™é‡Œå°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆç¨é¢æ˜ç»† -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- éšè—çš„æ–‡ä»¶ä¸Šä¼ input -->
    <input type="file" id="fileInput" accept=".json" style="display: none;">

    <script>
        const TAX_BRACKETS = [
            { threshold: 36000, rate: 0.03, deduction: 0 },
            { threshold: 144000, rate: 0.10, deduction: 2520 },
            { threshold: 300000, rate: 0.20, deduction: 16920 },
            { threshold: 420000, rate: 0.25, deduction: 31920 },
            { threshold: 660000, rate: 0.30, deduction: 52920 },
            { threshold: 960000, rate: 0.35, deduction: 85920 },
            { threshold: Infinity, rate: 0.45, deduction: 181920 }
        ];

        const MONTHLY_TAX_BRACKETS = [
            { threshold: 3000, rate: 0.03, deduction: 0 },
            { threshold: 12000, rate: 0.10, deduction: 210 },
            { threshold: 25000, rate: 0.20, deduction: 1410 },
            { threshold: 35000, rate: 0.25, deduction: 2660 },
            { threshold: 55000, rate: 0.30, deduction: 4410 },
            { threshold: 80000, rate: 0.35, deduction: 7160 },
            { threshold: Infinity, rate: 0.45, deduction: 15160 }
        ];

        let appState = {
            mode: 'monthly',
            income: {
                monthlyIncomes: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], // 12ä¸ªæœˆçš„å·¥èµ„æ•°ç»„
                yearly: 0,
                prepaidTax: 0,
                bonus: 0
            },
            deductions: {
                social: {
                    pension: 0,
                    medical: 0,
                    unemployment: 0,
                    housingFund: 0
                },
                additional: {
                    childEducation: { count: 0, ratio: 100 },
                    infantCare: { count: 0, ratio: 100 },
                    continuingEducation: { type: 'none' },
                    housing: { type: 'none', cityTier: 'tier1' },
                    elderCare: { qualified: false, siblings: 1, share: 0 }
                }
            }
        };

        function calculateTax(taxableIncome, brackets) {
            for (let i = 0; i < brackets.length; i++) {
                if (taxableIncome <= brackets[i].threshold) {
                    return taxableIncome * brackets[i].rate - brackets[i].deduction;
                }
            }
            return 0;
        }

        function calculateTaxDetails(taxableIncome) {
            const details = [];
            let remaining = taxableIncome;

            for (let i = 0; i < TAX_BRACKETS.length; i++) {
                const bracket = TAX_BRACKETS[i];
                const prevThreshold = i > 0 ? TAX_BRACKETS[i - 1].threshold : 0;
                const bracketSize = bracket.threshold - prevThreshold;

                if (remaining > 0) {
                    const taxedAmount = Math.min(remaining, bracketSize);
                    const tax = taxedAmount * bracket.rate;

                    details.push({
                        rate: bracket.rate,
                        amount: taxedAmount,
                        tax: tax
                    });

                    remaining -= taxedAmount;
                }
            }

            return details;
        }

        function getSocialDeductionTotal() {
            const { pension, medical, unemployment, housingFund } = appState.deductions.social;
            return pension + medical + unemployment + housingFund;
        }

        function getAdditionalDeductionTotal() {
            let total = 0;
            const additional = appState.deductions.additional;
            const perMonth = appState.mode === 'monthly';

            total += additional.childEducation.count * 2000 * (additional.childEducation.ratio / 100);
            total += additional.infantCare.count * 2000 * (additional.infantCare.ratio / 100);

            if (additional.continuingEducation.type === 'academic') {
                total += 400;
            } else if (additional.continuingEducation.type === 'vocational') {
                total += perMonth ? 300 : 3600;
            }

            if (additional.housing.type === 'loan') {
                total += 1000;
            } else if (additional.housing.type === 'rent') {
                const rentAmounts = { tier1: 1500, tier2: 1100, tier3: 800 };
                total += rentAmounts[additional.housing.cityTier] || 0;
            }

            if (additional.elderCare.qualified) {
                if (additional.elderCare.siblings === 1) {
                    total += 3000;
                } else {
                    total += Math.min(additional.elderCare.share, 1500);
                }
            }

            return total;
        }

        function calculateMonthlyTax() {
            const monthlyIncomes = appState.income.monthlyIncomes || [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
            const prepaidTax = appState.income.prepaidTax || 0;

            // è®¡ç®—ç´¯è®¡æ”¶å…¥ï¼ˆæ‰€æœ‰æœ‰æ”¶å…¥çš„æœˆä»½ï¼‰
            const accumulatedIncome = monthlyIncomes.reduce((sum, income) => sum + income, 0);

            // è®¡ç®—ç´¯è®¡æœˆæ•°ï¼ˆæœ‰æ”¶å…¥çš„æœˆä»½æ•°ï¼‰
            const monthsWithIncome = monthlyIncomes.filter(income => income > 0).length;
            const effectiveMonths = monthsWithIncome > 0 ? monthsWithIncome : 12; // å¦‚æœæ²¡æœ‰è¾“å…¥ï¼Œé»˜è®¤æŒ‰12ä¸ªæœˆ

            const basicDeduction = 5000 * effectiveMonths;
            const socialDeduction = getSocialDeductionTotal() * effectiveMonths;
            const additionalDeduction = getAdditionalDeductionTotal() * effectiveMonths;

            const taxableIncome = Math.max(0, accumulatedIncome - basicDeduction - socialDeduction - additionalDeduction);
            const accumulatedTax = calculateTax(taxableIncome, TAX_BRACKETS);
            const currentTax = Math.max(0, accumulatedTax - prepaidTax);

            return {
                taxableIncome: taxableIncome,
                tax: currentTax,
                accumulatedTax: accumulatedTax,
                totalIncome: accumulatedIncome,
                totalDeductions: basicDeduction + socialDeduction + additionalDeduction,
                netIncome: accumulatedIncome - getSocialDeductionTotal() * effectiveMonths - currentTax,
                effectiveMonths: effectiveMonths
            };
        }

        function calculateYearlyTax() {
            const yearlyIncome = appState.income.yearly;
            const basicDeduction = 60000;
            const socialDeduction = getSocialDeductionTotal() * 12;
            const additionalDeduction = getAdditionalDeductionTotal() * 12;

            const taxableIncome = Math.max(0, yearlyIncome - basicDeduction - socialDeduction - additionalDeduction);
            const tax = calculateTax(taxableIncome, TAX_BRACKETS);

            return {
                taxableIncome: taxableIncome,
                tax: tax,
                totalIncome: yearlyIncome,
                totalDeductions: basicDeduction + socialDeduction + additionalDeduction,
                netIncome: yearlyIncome - getSocialDeductionTotal() * 12 - tax
            };
        }

        function calculateBonus() {
            const bonus = appState.income.bonus;
            if (bonus <= 0) return null;

            const separateTax = calculateTax(bonus / 12, MONTHLY_TAX_BRACKETS) * 12;

            const baseResult = appState.mode === 'monthly' ? calculateMonthlyTax() : calculateYearlyTax();
            const combinedTaxableIncome = baseResult.taxableIncome + bonus;
            const combinedTax = calculateTax(combinedTaxableIncome, TAX_BRACKETS);
            const combinedBonusTax = combinedTax - baseResult.tax;

            return {
                separate: separateTax,
                combined: combinedBonusTax,
                recommendation: separateTax < combinedBonusTax ? 'separate' : 'combined',
                savings: Math.abs(separateTax - combinedBonusTax)
            };
        }

        function updateUI() {
            const result = appState.mode === 'monthly' ? calculateMonthlyTax() : calculateYearlyTax();

            document.getElementById('totalTaxAmount').textContent = `Â¥ ${result.tax.toLocaleString('zh-CN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            document.getElementById('netIncome').textContent = `Â¥ ${result.netIncome.toLocaleString('zh-CN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;

            const effectiveRate = result.totalIncome > 0 ? (result.tax / result.totalIncome * 100) : 0;
            document.getElementById('effectiveRate').textContent = `${effectiveRate.toFixed(2)}%`;

            document.getElementById('socialTotal').textContent = `Â¥ ${getSocialDeductionTotal().toLocaleString('zh-CN')}`;
            document.getElementById('additionalTotal').textContent = `Â¥ ${getAdditionalDeductionTotal().toLocaleString('zh-CN')}`;

            updateChildEducationDisplay();
            updateInfantCareDisplay();
            updateElderCareDisplay();
            updateEducationDisplay();
            updateHousingDisplay();
            updateTotalYearlyIncome();
            updateIncomeBreakdown(result);
            updateTaxDetails(result);
            updateBonusComparison();
            updateMonthlyDetails();

            saveToLocalStorage();
        }

        function updateChildEducationDisplay() {
            const count = appState.deductions.additional.childEducation.count;
            const ratio = appState.deductions.additional.childEducation.ratio;
            const amount = count * 2000 * (ratio / 100);
            document.getElementById('childEduAmount').textContent = `Â¥ ${amount.toLocaleString('zh-CN')}`;

            // åŒæ­¥æ˜¾ç¤ºçŠ¶æ€
            document.querySelectorAll('.child-options').forEach(el => {
                el.classList.toggle('hidden', count === 0);
            });
            document.querySelectorAll('#childEducation [data-ratio]').forEach(btn => {
                btn.classList.toggle('active', parseInt(btn.dataset.ratio) === ratio);
            });
        }

        function updateInfantCareDisplay() {
            const count = appState.deductions.additional.infantCare.count;
            const ratio = appState.deductions.additional.infantCare.ratio;
            const amount = count * 2000 * (ratio / 100);
            document.getElementById('infantAmount').textContent = `Â¥ ${amount.toLocaleString('zh-CN')}`;

            // åŒæ­¥æ˜¾ç¤ºçŠ¶æ€
            document.querySelectorAll('.infant-options').forEach(el => {
                el.classList.toggle('hidden', count === 0);
            });
            document.querySelectorAll('#infantCare [data-ratio]').forEach(btn => {
                btn.classList.toggle('active', parseInt(btn.dataset.ratio) === ratio);
            });
        }

        function updateElderCareDisplay() {
            const elder = appState.deductions.additional.elderCare;
            let amount = 0;
            if (elder.qualified) {
                amount = elder.siblings === 1 ? 3000 : Math.min(elder.share, 1500);
            }
            document.getElementById('elderAmount').textContent = `Â¥ ${amount.toLocaleString('zh-CN')}`;

            // åŒæ­¥æ˜¾ç¤ºçŠ¶æ€
            const isQualified = appState.deductions.additional.elderCare.qualified;
            document.querySelectorAll('.elder-options').forEach(el => {
                el.classList.toggle('hidden', !isQualified);
            });
            document.querySelectorAll('.elder-share').forEach(el => {
                el.classList.toggle('hidden', !isQualified || elder.siblings === 1);
            });
        }

        function updateEducationDisplay() {
            const type = appState.deductions.additional.continuingEducation.type;
            document.querySelectorAll('[data-edu-type]').forEach(opt => {
                opt.classList.toggle('active', opt.dataset.eduType === type);
            });
        }

        function updateHousingDisplay() {
            const type = appState.deductions.additional.housing.type;
            const cityTier = appState.deductions.additional.housing.cityTier;
            document.querySelectorAll('[data-housing-type]').forEach(opt => {
                opt.classList.toggle('active', opt.dataset.housingType === type);
            });
            document.querySelectorAll('.rent-options').forEach(el => {
                el.classList.toggle('hidden', type !== 'rent');
            });
            document.querySelectorAll('.housing-warning').forEach(el => {
                el.classList.toggle('hidden', type === 'none');
            });
            document.querySelectorAll('[data-city-tier]').forEach(opt => {
                opt.classList.toggle('active', opt.dataset.cityTier === cityTier);
            });
        }

        function updateTotalYearlyIncome() {
            if (appState.mode === 'monthly') {
                const total = appState.income.monthlyIncomes.reduce((sum, income) => sum + income, 0);
                document.getElementById('totalYearlyIncome').textContent = `Â¥ ${total.toLocaleString('zh-CN')}`;
            }
        }

        function updateMonthlyDetails() {
            const tbody = document.getElementById('monthlyTableBody');
            if (!tbody) return;

            const monthlyIncomes = appState.income.monthlyIncomes || [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
            const socialDeduction = getSocialDeductionTotal();
            const additionalDeduction = getAdditionalDeductionTotal();
            const monthNames = ['1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ', '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ'];

            let accumulatedIncome = 0;
            let accumulatedDeduction = 0;
            let accumulatedTax = 0;
            let html = '';

            for (let i = 0; i < 12; i++) {
                const monthIncome = monthlyIncomes[i] || 0;

                if (monthIncome > 0) {
                    accumulatedIncome += monthIncome;
                    accumulatedDeduction += 5000 + socialDeduction + additionalDeduction;

                    const taxableIncome = Math.max(0, accumulatedIncome - accumulatedDeduction);
                    const totalTaxSoFar = calculateTax(taxableIncome, TAX_BRACKETS);
                    const monthTax = Math.max(0, totalTaxSoFar - accumulatedTax);
                    accumulatedTax = totalTaxSoFar;

                    const netSalary = monthIncome - socialDeduction - monthTax;

                    html += `
                        <tr style="border-bottom: 1px solid var(--border-light);">
                            <td style="padding: 0.75rem 0.5rem; color: var(--text-primary); font-weight: 500;">${monthNames[i]}</td>
                            <td style="padding: 0.75rem 0.5rem; text-align: right; color: var(--text-secondary); font-family: 'SF Mono', monospace;">Â¥ ${monthIncome.toLocaleString('zh-CN')}</td>
                            <td style="padding: 0.75rem 0.5rem; text-align: right; color: var(--error-500); font-family: 'SF Mono', monospace;">Â¥ ${monthTax.toLocaleString('zh-CN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                            <td style="padding: 0.75rem 0.5rem; text-align: right; color: var(--success-600); font-weight: 600; font-family: 'SF Mono', monospace;">Â¥ ${netSalary.toLocaleString('zh-CN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                        </tr>
                    `;
                } else {
                    html += `
                        <tr style="border-bottom: 1px solid var(--border-light); opacity: 0.5;">
                            <td style="padding: 0.75rem 0.5rem; color: var(--text-tertiary);">${monthNames[i]}</td>
                            <td style="padding: 0.75rem 0.5rem; text-align: right; color: var(--text-tertiary);">-</td>
                            <td style="padding: 0.75rem 0.5rem; text-align: right; color: var(--text-tertiary);">-</td>
                            <td style="padding: 0.75rem 0.5rem; text-align: right; color: var(--text-tertiary);">-</td>
                        </tr>
                    `;
                }
            }

            tbody.innerHTML = html;
        }

        function updateIncomeBreakdown(result) {
            const container = document.getElementById('incomeBreakdown');
            const total = result.totalIncome;

            if (total === 0) {
                container.innerHTML = '<div style="color: var(--text-secondary); text-align: center; padding: 2rem;">è¯·è¾“å…¥æ”¶å…¥ä¿¡æ¯</div>';
                return;
            }

            const effectiveMonths = result.effectiveMonths || 12;
            const items = [
                { label: 'ç¨å‰æ”¶å…¥', amount: total, color: 'var(--primary-500)' },
                { label: 'åŸºæœ¬æ‰£é™¤', amount: appState.mode === 'monthly' ? 5000 * effectiveMonths : 60000, color: 'var(--text-tertiary)' },
                { label: 'ä¸“é¡¹æ‰£é™¤', amount: getSocialDeductionTotal() * (appState.mode === 'monthly' ? effectiveMonths : 12), color: 'var(--text-tertiary)' },
                { label: 'é™„åŠ æ‰£é™¤', amount: getAdditionalDeductionTotal() * (appState.mode === 'monthly' ? effectiveMonths : 12), color: 'var(--info-500)' },
                { label: 'åº”çº³ç¨æ‰€å¾—é¢', amount: result.taxableIncome, color: 'var(--warning-500)' },
                { label: 'ä¸ªäººæ‰€å¾—ç¨', amount: result.tax, color: 'var(--error-500)' },
                { label: 'å®é™…åˆ°æ‰‹', amount: result.netIncome, color: 'var(--success-500)' }
            ];

            let html = '<div class="progress-container" style="display: flex; flex-direction: column; gap: 0.75rem;">';
            items.forEach(item => {
                const percentage = total > 0 ? (item.amount / total * 100) : 0;
                html += `
                    <div class="progress-item" style="display: flex; flex-direction: column; gap: 0.25rem;">
                        <div class="progress-header" style="display: flex; justify-content: space-between; font-size: 0.875rem;">
                            <span class="progress-label" style="color: var(--text-secondary); font-weight: 500;">${item.label}</span>
                            <span class="progress-value" style="color: ${item.color}; font-weight: 600; font-family: 'SF Mono', monospace;">Â¥ ${item.amount.toLocaleString('zh-CN')} <span style="font-size: 0.75rem; color: var(--text-tertiary);">(${percentage.toFixed(1)}%)</span></span>
                        </div>
                        <div class="progress-track" style="width: 100%; height: 8px; background: var(--bg-tertiary); border-radius: 4px; overflow: hidden;">
                            <div class="progress-bar" style="width: ${percentage}%; height: 100%; background: ${item.color}; border-radius: 4px; transition: width 0.5s ease;"></div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';

            container.innerHTML = html;
        }

        function updateTaxDetails(result) {
            const container = document.getElementById('taxDetails');

            if (result.taxableIncome === 0) {
                container.innerHTML = '<div style="color: var(--text-secondary); text-align: center; padding: 2rem;">æ— éœ€çº³ç¨</div>';
                return;
            }

            const details = calculateTaxDetails(result.taxableIncome);

            let html = `
                <div style="margin-bottom: var(--spacing-md);">
                    <div style="color: var(--text-secondary); font-size: 0.875rem; margin-bottom: 0.5rem;">åº”çº³ç¨æ‰€å¾—é¢</div>
                    <div style="color: var(--primary-600); font-size: 1.5rem; font-weight: 600; font-family: 'SF Mono', monospace;">Â¥ ${result.taxableIncome.toLocaleString('zh-CN')}</div>
                </div>
                <div class="divider"></div>
                <div style="color: var(--text-secondary); font-size: 0.875rem; margin-bottom: var(--spacing-sm);">ç¨ç‡åˆ†æ¡£è®¡ç®—</div>
                <div style="display: flex; flex-direction: column; gap: 0.5rem;">
            `;

            details.forEach(detail => {
                html += `
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: var(--spacing-sm); padding: 0.75rem; background: var(--bg-tertiary); border-radius: var(--radius-md); font-size: 0.875rem;">
                        <div>
                            <div style="color: var(--text-tertiary); font-size: 0.75rem;">ç¨ç‡</div>
                            <div style="color: var(--warning-600); font-weight: 600;">${(detail.rate * 100).toFixed(0)}%</div>
                        </div>
                        <div>
                            <div style="color: var(--text-tertiary); font-size: 0.75rem;">é‡‘é¢</div>
                            <div style="color: var(--text-primary);">Â¥ ${detail.amount.toLocaleString('zh-CN')}</div>
                        </div>
                        <div>
                            <div style="color: var(--text-tertiary); font-size: 0.75rem;">ç¨é¢</div>
                            <div style="color: var(--error-600); font-weight: 600;">Â¥ ${detail.tax.toLocaleString('zh-CN', { minimumFractionDigits: 2 })}</div>
                        </div>
                    </div>
                `;
            });

            html += '</div>';

            if (appState.mode === 'monthly' && appState.income.prepaidTax > 0) {
                const shouldPay = result.tax;
                html += `
                    <div class="divider"></div>
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: var(--spacing-sm); background: var(--primary-50); border-radius: var(--radius-md);">
                        <span style="color: var(--text-secondary); font-size: 0.875rem;">æœ¬æœˆåº”è¡¥(é€€)ç¨</span>
                        <span style="color: var(--primary-600); font-size: 1.25rem; font-weight: 700; font-family: 'SF Mono', monospace;">Â¥ ${shouldPay.toLocaleString('zh-CN', { minimumFractionDigits: 2 })}</span>
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        function updateBonusComparison() {
            const bonusResult = calculateBonus();
            const container = document.getElementById('bonusComparison');

            if (!bonusResult) {
                container.classList.add('hidden');
                return;
            }

            container.classList.remove('hidden');

            document.getElementById('bonusSeparateTax').textContent = `Â¥ ${bonusResult.separate.toLocaleString('zh-CN', { minimumFractionDigits: 2 })}`;
            document.getElementById('bonusCombinedTax').textContent = `Â¥ ${bonusResult.combined.toLocaleString('zh-CN', { minimumFractionDigits: 2 })}`;

            const recommendation = document.getElementById('bonusRecommendation');
            if (bonusResult.recommendation === 'separate') {
                recommendation.textContent = `âœ“ æ¨èä½¿ç”¨å•ç‹¬è®¡ç¨ï¼Œå¯èŠ‚çœ Â¥${bonusResult.savings.toLocaleString('zh-CN', { minimumFractionDigits: 2 })}`;
                recommendation.className = 'alert alert-warning';
            } else {
                recommendation.textContent = `âœ“ æ¨èä½¿ç”¨åˆå¹¶è®¡ç¨ï¼Œå¯èŠ‚çœ Â¥${bonusResult.savings.toLocaleString('zh-CN', { minimumFractionDigits: 2 })}`;
                recommendation.className = 'alert alert-warning';
            }
        }

        function initEventListeners() {
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    appState.mode = btn.dataset.mode;

                    document.querySelectorAll('.monthly-only').forEach(el => {
                        el.classList.toggle('hidden', appState.mode !== 'monthly');
                    });
                    document.querySelectorAll('.yearly-only').forEach(el => {
                        el.classList.toggle('hidden', appState.mode !== 'yearly');
                    });

                    updateUI();
                });
            });

            // å¹´åº¦æ”¶å…¥è¾“å…¥
            document.getElementById('yearlyIncomeInput').addEventListener('input', debounce((e) => {
                appState.income.yearly = parseFloat(e.target.value) || 0;
                updateUI();
            }, 300));

            // ä¸»æœˆåº¦æ”¶å…¥è¾“å…¥ï¼ˆè‡ªåŠ¨åº”ç”¨åˆ°å…¨å¹´ï¼‰
            document.getElementById('monthlyIncomeInput').addEventListener('input', debounce((e) => {
                const value = parseFloat(e.target.value) || 0;
                // æ›´æ–°çŠ¶æ€æ•°ç»„
                appState.income.monthlyIncomes.fill(value);

                // åŒæ­¥æ›´æ–° 12 ä¸ªæœˆæ˜ç»†è¾“å…¥æ¡†çš„å€¼
                document.querySelectorAll('.monthly-income-input').forEach(input => {
                    input.value = value || '';
                });

                updateUI();
            }, 300));

            // æœˆåº¦æ”¶å…¥æ˜ç»†è¾“å…¥æ¡†ï¼ˆå•ç‹¬è°ƒæ•´ï¼‰
            document.querySelectorAll('.monthly-income-input').forEach(input => {
                input.addEventListener('input', debounce((e) => {
                    const month = parseInt(e.target.dataset.month);
                    const value = parseFloat(e.target.value) || 0;
                    appState.income.monthlyIncomes[month - 1] = value;

                    // å½“æ˜ç»†è¢«ä¿®æ”¹æ—¶ï¼Œä¸»è¾“å…¥æ¡†çš„å€¼å°±ä¸å†ä»£è¡¨å…¨å¹´ç»Ÿä¸€ï¼Œæ¸…ç©ºå®ƒæˆ–ä¿æŒç°çŠ¶ï¼ˆè¿™é‡Œé€‰æ‹©ä¿æŒç°çŠ¶ï¼Œé€šå¸¸ç”¨æˆ·ä¼šçŸ¥é“ä»–åœ¨åšå¾®è°ƒï¼‰
                    updateUI();
                }, 300));
            });

            document.querySelectorAll('[data-preset]').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('[data-preset]').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');

                    const preset = btn.dataset.preset;
                    if (preset === '22.5') {
                        let income = 0;
                        if (appState.mode === 'monthly') {
                            // è®¡ç®—æœ‰æ”¶å…¥æœˆä»½çš„å¹³å‡å·¥èµ„
                            const totalIncome = appState.income.monthlyIncomes.reduce((sum, val) => sum + val, 0);
                            const monthsWithIncome = appState.income.monthlyIncomes.filter(val => val > 0).length;
                            income = monthsWithIncome > 0 ? totalIncome / monthsWithIncome : 0;
                        } else {
                            income = appState.income.yearly / 12;
                        }

                        document.getElementById('pensionInput').value = Math.round(income * 0.08);
                        document.getElementById('medicalInput').value = Math.round(income * 0.02);
                        document.getElementById('unemploymentInput').value = Math.round(income * 0.005);
                        document.getElementById('housingFundInput').value = Math.round(income * 0.12);

                        appState.deductions.social.pension = Math.round(income * 0.08);
                        appState.deductions.social.medical = Math.round(income * 0.02);
                        appState.deductions.social.unemployment = Math.round(income * 0.005);
                        appState.deductions.social.housingFund = Math.round(income * 0.12);

                        updateUI();
                    }
                });
            });

            document.querySelectorAll('.social-input').forEach(input => {
                input.addEventListener('input', debounce((e) => {
                    const id = e.target.id;
                    const value = parseFloat(e.target.value) || 0;

                    if (id === 'pensionInput') appState.deductions.social.pension = value;
                    else if (id === 'medicalInput') appState.deductions.social.medical = value;
                    else if (id === 'unemploymentInput') appState.deductions.social.unemployment = value;
                    else if (id === 'housingFundInput') appState.deductions.social.housingFund = value;

                    document.querySelectorAll('[data-preset]').forEach(b => b.classList.remove('active'));
                    document.querySelector('[data-preset="custom"]').classList.add('active');

                    updateUI();
                }, 300));
            });

            document.querySelectorAll('.collapse-header').forEach(header => {
                header.addEventListener('click', () => {
                    const target = document.getElementById(header.dataset.target);
                    const icon = header.querySelector('.collapse-icon');

                    target.classList.toggle('expanded');
                    icon.classList.toggle('expanded');
                });
            });

            document.querySelectorAll('[data-children]').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('[data-children]').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');

                    const count = parseInt(btn.dataset.children);
                    appState.deductions.additional.childEducation.count = count;

                    document.querySelectorAll('.child-options').forEach(el => {
                        el.classList.toggle('hidden', count === 0);
                    });

                    updateUI();
                });
            });

            document.querySelectorAll('#childEducation [data-ratio]').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('#childEducation [data-ratio]').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');

                    appState.deductions.additional.childEducation.ratio = parseInt(btn.dataset.ratio);
                    updateUI();
                });
            });

            document.querySelectorAll('[data-infants]').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('[data-infants]').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');

                    const count = parseInt(btn.dataset.infants);
                    appState.deductions.additional.infantCare.count = count;

                    document.querySelectorAll('.infant-options').forEach(el => {
                        el.classList.toggle('hidden', count === 0);
                    });

                    updateUI();
                });
            });

            document.querySelectorAll('#infantCare [data-ratio]').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('#infantCare [data-ratio]').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');

                    appState.deductions.additional.infantCare.ratio = parseInt(btn.dataset.ratio);
                    updateUI();
                });
            });

            document.querySelectorAll('[data-edu-type]').forEach(option => {
                option.addEventListener('click', () => {
                    document.querySelectorAll('[data-edu-type]').forEach(o => o.classList.remove('active'));
                    option.classList.add('active');

                    appState.deductions.additional.continuingEducation.type = option.dataset.eduType;
                    updateUI();
                });
            });

            document.querySelectorAll('[data-housing-type]').forEach(option => {
                option.addEventListener('click', () => {
                    document.querySelectorAll('[data-housing-type]').forEach(o => o.classList.remove('active'));
                    option.classList.add('active');

                    const type = option.dataset.housingType;
                    appState.deductions.additional.housing.type = type;

                    document.querySelectorAll('.rent-options').forEach(el => {
                        el.classList.toggle('hidden', type !== 'rent');
                    });

                    updateUI();
                });
            });

            document.querySelectorAll('[data-city-tier]').forEach(option => {
                option.addEventListener('click', () => {
                    document.querySelectorAll('[data-city-tier]').forEach(o => o.classList.remove('active'));
                    option.classList.add('active');

                    appState.deductions.additional.housing.cityTier = option.dataset.cityTier;
                    updateUI();
                });
            });

            document.querySelectorAll('[data-elder-age]').forEach(option => {
                option.addEventListener('click', () => {
                    document.querySelectorAll('[data-elder-age]').forEach(o => o.classList.remove('active'));
                    option.classList.add('active');

                    const qualified = option.dataset.elderAge === 'qualified';
                    appState.deductions.additional.elderCare.qualified = qualified;

                    document.querySelectorAll('.elder-options').forEach(el => {
                        el.classList.toggle('hidden', !qualified);
                    });

                    updateUI();
                });
            });

            document.querySelectorAll('[data-siblings]').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('[data-siblings]').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');

                    const siblings = parseInt(btn.dataset.siblings);
                    appState.deductions.additional.elderCare.siblings = siblings;

                    if (siblings > 1) {
                        const averageShare = Math.min(Math.floor(3000 / siblings), 1500);
                        appState.deductions.additional.elderCare.share = averageShare;
                        document.getElementById('elderShareInput').value = averageShare;
                    }

                    document.querySelectorAll('.elder-share').forEach(el => {
                        el.classList.toggle('hidden', siblings === 1);
                    });

                    updateUI();
                });
            });

            document.getElementById('elderShareInput').addEventListener('input', debounce((e) => {
                const value = Math.min(parseFloat(e.target.value) || 0, 1500);
                appState.deductions.additional.elderCare.share = value;
                e.target.value = value;
                updateUI();
            }, 300));

            document.getElementById('bonusInput').addEventListener('input', debounce((e) => {
                appState.income.bonus = parseFloat(e.target.value) || 0;
                updateUI();
            }, 300));

            document.getElementById('exportBtn').addEventListener('click', exportData);
            document.getElementById('importBtn').addEventListener('click', () => {
                document.getElementById('fileInput').click();
            });
            document.getElementById('fileInput').addEventListener('change', importData);
            document.getElementById('clearBtn').addEventListener('click', clearData);
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function saveToLocalStorage() {
            try {
                localStorage.setItem('taxCalculatorData', JSON.stringify(appState));
            } catch (e) {
                console.error('Failed to save to localStorage:', e);
            }
        }

        function loadFromLocalStorage() {
            try {
                const saved = localStorage.getItem('taxCalculatorData');
                if (saved) {
                    const data = JSON.parse(saved);

                    // å®‰å…¨åˆå¹¶æ•°æ®ï¼Œé˜²æ­¢ä¸¢å¤±é»˜è®¤å­—æ®µå¯¼è‡´ NaN
                    appState = {
                        mode: data.mode || 'monthly',
                        income: { ...appState.income, ...(data.income || {}) },
                        deductions: {
                            social: { ...appState.deductions.social, ...(data.deductions?.social || {}) },
                            additional: { ...appState.deductions.additional, ...(data.deductions?.additional || {}) }
                        }
                    };

                    // å…¼å®¹æ—§æ•°æ®æ ¼å¼
                    if (appState.income && !appState.income.monthlyIncomes) {
                        appState.income.monthlyIncomes = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
                        if (appState.income.monthly) {
                            appState.income.monthlyIncomes.fill(appState.income.monthly);
                        }
                    }

                    // å®‰å…¨åœ°æ›´æ–° DOM
                    const yearlyInput = document.getElementById('yearlyIncomeInput');
                    if (yearlyInput) yearlyInput.value = appState.income.yearly || '';

                    appState.income.monthlyIncomes.forEach((income, index) => {
                        const input = document.querySelector(`.monthly-income-input[data-month="${index + 1}"]`);
                        if (input) {
                            input.value = income || '';
                        }
                    });

                    const monthlyMainInput = document.getElementById('monthlyIncomeInput');
                    if (monthlyMainInput) {
                        const allSame = appState.income.monthlyIncomes.every(val => val === appState.income.monthlyIncomes[0]);
                        if (allSame && appState.income.monthlyIncomes[0] > 0) {
                            monthlyMainInput.value = appState.income.monthlyIncomes[0];
                        } else {
                            monthlyMainInput.value = '';
                        }
                    }

                    const setVal = (id, val) => {
                        const el = document.getElementById(id);
                        if (el) el.value = val || '';
                    };

                    setVal('pensionInput', appState.deductions.social.pension);
                    setVal('medicalInput', appState.deductions.social.medical);
                    setVal('unemploymentInput', appState.deductions.social.unemployment);
                    setVal('housingFundInput', appState.deductions.social.housingFund);
                    setVal('bonusInput', appState.income.bonus);

                    // åŒæ­¥ä¸“é¡¹é™„åŠ æ‰£é™¤çš„UIçŠ¶æ€
                    const additional = appState.deductions.additional;

                    // å­å¥³æ•™è‚²
                    const childCount = additional.childEducation?.count || 0;
                    document.querySelectorAll('[data-children]').forEach(btn => {
                        const value = parseInt(btn.dataset.children);
                        btn.classList.toggle('active', value === childCount);
                    });
                    document.querySelectorAll('.child-options').forEach(el => {
                        el.classList.toggle('hidden', childCount === 0);
                    });
                    const childRatio = additional.childEducation?.ratio || 100;
                    document.querySelectorAll('[data-child-ratio]').forEach(btn => {
                        const value = parseInt(btn.dataset.childRatio);
                        btn.classList.toggle('active', value === childRatio);
                    });

                    // å©´å¹¼å„¿ç…§æŠ¤
                    const infantCount = additional.infantCare?.count || 0;
                    document.querySelectorAll('[data-infants]').forEach(btn => {
                        const value = parseInt(btn.dataset.infants);
                        btn.classList.toggle('active', value === infantCount);
                    });
                    document.querySelectorAll('.infant-options').forEach(el => {
                        el.classList.toggle('hidden', infantCount === 0);
                    });
                    const infantRatio = additional.infantCare?.ratio || 100;
                    document.querySelectorAll('[data-infant-ratio]').forEach(btn => {
                        const value = parseInt(btn.dataset.infantRatio);
                        btn.classList.toggle('active', value === infantRatio);
                    });

                    // ç»§ç»­æ•™è‚²
                    const eduType = additional.continuingEducation?.type || 'none';
                    document.querySelectorAll('[data-education]').forEach(option => {
                        option.classList.toggle('active', option.dataset.education === eduType);
                    });

                    // ä½æˆ¿
                    const housingType = additional.housing?.type || 'none';
                    document.querySelectorAll('[data-housing]').forEach(option => {
                        option.classList.toggle('active', option.dataset.housing === housingType);
                    });
                    const cityTier = additional.housing?.cityTier || 'tier1';
                    document.querySelectorAll('[data-city]').forEach(btn => {
                        btn.classList.toggle('active', btn.dataset.city === cityTier);
                    });
                    document.querySelectorAll('.housing-options').forEach(el => {
                        el.classList.toggle('hidden', housingType !== 'rent');
                    });

                    // èµ¡å…»è€äºº
                    const elderQualified = additional.elderCare?.qualified || false;
                    document.querySelectorAll('[data-elder-age]').forEach(option => {
                        const isQualifiedOption = option.dataset.elderAge === 'qualified';
                        option.classList.toggle('active', isQualifiedOption === elderQualified);
                    });
                    document.querySelectorAll('.elder-options').forEach(el => {
                        el.classList.toggle('hidden', !elderQualified);
                    });
                    const siblings = additional.elderCare?.siblings || 1;
                    document.querySelectorAll('[data-siblings]').forEach(btn => {
                        const value = parseInt(btn.dataset.siblings);
                        btn.classList.toggle('active', value === siblings);
                    });
                    const elderShare = additional.elderCare?.share || 0;
                    setVal('elderShareInput', elderShare);
                    document.querySelectorAll('.elder-share').forEach(el => {
                        el.classList.toggle('hidden', !elderQualified || siblings === 1);
                    });

                    updateUIFromState();
                }
            } catch (e) {
                console.error('Failed to load from localStorage:', e);
            }
        }

        function updateUIFromState() {
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.mode === appState.mode);
            });

            document.querySelectorAll('.monthly-only').forEach(el => {
                el.classList.toggle('hidden', appState.mode !== 'monthly');
            });
            document.querySelectorAll('.yearly-only').forEach(el => {
                el.classList.toggle('hidden', appState.mode !== 'yearly');
            });

            updateUI();
        }

        function exportData() {
            const dataStr = JSON.stringify(appState, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ä¸ªç¨è®¡ç®—æ•°æ®_${new Date().toISOString().slice(0, 10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function importData(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const imported = JSON.parse(event.target.result);

                    if (imported.mode && imported.income && imported.deductions) {
                        // æ·±åº¦åˆå¹¶å¯¼å…¥çš„æ•°æ®ï¼Œç¡®ä¿åµŒå¥—å¯¹è±¡æ­£ç¡®åˆå¹¶
                        appState = {
                            mode: imported.mode,
                            income: { ...imported.income },
                            deductions: {
                                social: { ...imported.deductions.social },
                                additional: {
                                    childEducation: { ...imported.deductions.additional?.childEducation },
                                    infantCare: { ...imported.deductions.additional?.infantCare },
                                    continuingEducation: { ...imported.deductions.additional?.continuingEducation },
                                    housing: { ...imported.deductions.additional?.housing },
                                    elderCare: { ...imported.deductions.additional?.elderCare }
                                }
                            }
                        };

                        saveToLocalStorage();
                        loadFromLocalStorage();
                        alert('æ•°æ®å¯¼å…¥æˆåŠŸï¼');
                    } else {
                        alert('å¯¼å…¥å¤±è´¥ï¼šæ•°æ®æ ¼å¼ä¸æ­£ç¡®');
                    }
                } catch (error) {
                    alert('å¯¼å…¥å¤±è´¥ï¼š' + error.message);
                }
            };
            reader.readAsText(file);

            e.target.value = '';
        }

        function clearData() {
            if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) return;

            appState = {
                mode: 'monthly',
                income: {
                    monthlyIncomes: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                    yearly: 0,
                    prepaidTax: 0,
                    bonus: 0
                },
                deductions: {
                    social: {
                        pension: 0,
                        medical: 0,
                        unemployment: 0,
                        housingFund: 0
                    },
                    additional: {
                        childEducation: { count: 0, ratio: 100 },
                        infantCare: { count: 0, ratio: 100 },
                        continuingEducation: { type: 'none' },
                        housing: { type: 'none', cityTier: 'tier1' },
                        elderCare: { qualified: false, siblings: 1, share: 0 }
                    }
                }
            };

            document.querySelectorAll('input[type="number"]').forEach(input => input.value = '');
            const monthlyMainInput = document.getElementById('monthlyIncomeInput');
            if (monthlyMainInput) monthlyMainInput.value = '';
            const yearlyInput = document.getElementById('yearlyIncomeInput');
            if (yearlyInput) yearlyInput.value = '';

            // æ¸…é™¤ç»“æœæ˜¾ç¤ºåŒºåŸŸ
            document.getElementById('totalTaxAmount').textContent = 'Â¥ 0.00';
            document.getElementById('netIncome').textContent = 'Â¥ 0.00';
            document.getElementById('effectiveRate').textContent = '0.00%';
            document.getElementById('socialTotal').textContent = 'Â¥ 0';
            document.getElementById('additionalTotal').textContent = 'Â¥ 0';

            // æ”¶èµ·æ‰€æœ‰æŠ˜å é¢æ¿
            document.querySelectorAll('.collapse-content').forEach(el => el.classList.remove('expanded'));
            document.querySelectorAll('.collapse-icon').forEach(el => el.classList.remove('expanded'));

            document.querySelectorAll('.btn-option').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.radio-option').forEach(option => option.classList.remove('active'));

            const pDefaults = {
                '[data-preset="22.5"]': true,
                '[data-children="0"]': true,
                '[data-infants="0"]': true,
                '[data-edu-type="none"]': true,
                '[data-housing-type="none"]': true,
                '[data-elder-age="none"]': true,
                '[data-siblings="1"]': true
            };

            Object.keys(pDefaults).forEach(selector => {
                const el = document.querySelector(selector);
                if (el) el.classList.add('active');
            });

            saveToLocalStorage();
            updateUIFromState();

            // æç¤ºæ¸…ç©ºæˆåŠŸ
            console.log('Data cleared successfully');
        }

        document.addEventListener('DOMContentLoaded', () => {
            initEventListeners();
            loadFromLocalStorage();
            updateUI();
        });
    </script>
</body>

</html>